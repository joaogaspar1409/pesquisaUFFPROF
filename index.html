<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa UFF - Localização Residencial dos Professores</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <style>
        /* Paleta de cores UFF: Azul Principal (#0056b3) */
        body { 
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #f7f9fc; /* Fundo mais claro */
            color: #343a3f;
        }
        .container { 
            max-width: 780px; 
            margin: 30px auto; 
            background: #ffffff; 
            padding: 40px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo img {
            max-width: 150px;
            height: auto;
        }
        .header-info { 
            border-bottom: 2px solid #0056b3;
            padding-bottom: 15px; 
            margin-bottom: 30px; 
        }
        h1 { 
            color: #0056b3; 
            font-size: 1.8em; 
            text-align: center; 
            margin-bottom: 15px; 
            line-height: 1.3; 
            font-weight: 700;
        }
        .info-credibilidade { 
            background-color: #e6f7ff;
            border-left: 4px solid #0056b3; 
            padding: 18px; 
            margin-top: 20px; 
            border-radius: 4px; 
            font-size: 0.95em; 
            line-height: 1.6;
        }
        .info-credibilidade strong { display: block; margin-bottom: 8px; font-size: 1.1em; color: #004085; }
        .pesquisador { font-weight: bold; color: #343a3f; }
        label { 
            display: block; 
            margin-top: 25px; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #495057; 
            font-size: 1em;
        }
        input[type="text"], select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ced4da; 
            border-radius: 6px; 
            box-sizing: border-box; 
            transition: all 0.3s; 
            background-color: #ffffff; 
            font-size: 1em;
        }
        input[type="text"]:focus, select:focus { 
            border-color: #007bff; 
            outline: none; 
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); 
        }
        .coordenada-field { 
            background-color: #e9ecef; 
            font-style: italic; 
            color: #6c757d; 
            font-weight: normal; 
            cursor: default;
        }
        /* Estilo para a caixa do mapa */
        #mapaResidencia {
            height: 350px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 6px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        #message { 
            margin-top: 30px; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: bold; 
            transition: all 0.3s; 
            font-size: 1em;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info-mapa { 
            margin-top: 10px; 
            padding: 15px; 
            background-color: #e6f7ff; 
            border: 1px solid #b3e0ff; 
            border-radius: 6px; 
            font-size: 0.9em;
        }
        .info-coleta {
             padding: 10px; 
             background-color: #f8f9fa;
             border-left: 3px solid #6c757d;
             margin-top: 15px;
             font-size: 0.9em;
        }
        button { 
            background-color: #0056b3; /* Azul UFF */
            color: white; 
            padding: 16px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1.2em; 
            margin-top: 35px; 
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s; 
        }
        button:hover { 
            background-color: #004085; /* Azul mais escuro */
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .radio-group { display: flex; gap: 20px; margin-top: 10px; }
        .radio-group input[type="radio"] { margin-right: 5px; }
        #outrasEscolasDetalhe { margin-top: 15px; display: none; }
        #contatoDetalhe { margin-top: 15px; display: none; }
        ul { padding-left: 20px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <img src="logo-uff.png" alt="Logotipo da UFF">
    </div>

    <div class="header-info">
        <h1>Situação Geográfica das Escolas: Coordenadas da sua Residência</h1>
        
        <div class="info-credibilidade">
            <p><strong>Atenção: Uso de Dados Exclusivamente Acadêmicos</strong></p>
            <p>Os dados de localização serão coletados de <b>duas formas</b>:</p>
            <ul>
                <li><b>Localização Residencial (Manual):</b> Marcada por você no mapa. (<b>Foco da pesquisa</b>)</li>
                <li><b>Localização de Acesso (Automática):</b> Coletada pelo navegador no momento do envio.</li>
            </ul>
            <p>Ambas as coordenadas, Latitudes e Longitudes, **só serão utilizadas para fins acadêmicos** da pesquisa da UFF, garantindo sua privacidade.</p>
            <p class="pesquisador">Pesquisa realizada por: João Victor Gaspar Martins</p>
            <p>Programa de Pós-graduação em Geografia da **Universidade Federal Fluminense (UFF)**.</p>
        </div>
    </div>

    <form id="coletaForm">
        
        <label for="nomeCompleto">Seu Nome Completo:</label>
        <input type="text" id="nomeCompleto" name="nomeCompleto" required>

        <label for="nomeEscola">Escola em que leciona (Atual):</label>
        <select id="nomeEscola" name="nomeEscola" required>
            <option value="" disabled selected>Selecione sua escola</option>
            <option value="CIEP 353 Dr. Brochado da Rocha">CIEP 353 Dr. Brochado da Rocha</option>
            <option value="Escola Municipal Engenheiro Elias Faraht">Escola Municipal Engenheiro Elias Faraht</option>
        </select>

        <label for="tempoTrabalho">Há quanto tempo você trabalha nesta escola?</label>
        <select id="tempoTrabalho" name="tempoTrabalho" required>
            <option value="" disabled selected>Selecione a faixa de tempo</option>
            <option value="Menos de 1 ano">Menos de 1 ano</option>
            <option value="Entre 1 e 5 anos">Entre 1 e 5 anos</option>
            <option value="Entre 5 e 10 anos">Entre 5 e 10 anos</option>
            <option value="Mais de 10 anos">Mais de 10 anos</option>
        </select>
        
        <label>Você trabalha em outras escolas além desta?</label>
        <div class="radio-group">
            <label><input type="radio" name="trabalhaOutrasEscolas" value="Sim" required> Sim</label>
            <label><input type="radio" name="trabalhaOutrasEscolas" value="Não"> Não</label>
        </div>

        <div id="outrasEscolasDetalhe">
            <label for="detalheOutrasEscolas">Se sim, em qual(is) outra(s) escola(s) você trabalha? (Nome da Escola e Município)</label>
            <input type="text" id="detalheOutrasEscolas" name="detalheOutrasEscolas" placeholder="Ex: Escola Estadual XXX, Niterói">
        </div>
        
        <label>Localização da sua **RESIDÊNCIA** (Coordenada Manual - Obrigatório):</label>
        <div class="info-mapa">
            <p><strong>Instruções:</strong> Dê zoom no mapa e **clique no local da sua residência** para gerar as coordenadas. Sua Latitude e Longitude serão preenchidas automaticamente abaixo.</p>
        </div>
        <div id="mapaResidencia"></div>

        <label for="latitudeResidencial">Latitude Residencial (Manual):</label>
        <input type="text" id="latitudeResidencial" name="latitudeResidencial" class="coordenada-field" readonly required value="Marque seu local no mapa acima">

        <label for="longitudeResidencial">Longitude Residencial (Manual):</label>
        <input type="text" id="longitudeResidencial" name="longitudeResidencial" class="coordenada-field" readonly required value="Marque seu local no mapa acima">
        
        <label>Localização de Acesso (Coordenada Automática - Opcional):</label>
        <div class="info-coleta">
            <p>Esta coordenada é capturada automaticamente pelo seu dispositivo no momento do envio. **Por favor, permita o acesso à localização.**</p>
        </div>
        <label for="latitudeAcesso">Latitude de Acesso (Automática):</label>
        <input type="text" id="latitudeAcesso" name="latitudeAcesso" class="coordenada-field" readonly required value="Tentando obter localização de acesso...">

        <label for="longitudeAcesso">Longitude de Acesso (Automática):</label>
        <input type="text" id="longitudeAcesso" name="longitudeAcesso" class="coordenada-field" readonly required value="Tentando obter localização de acesso...">
        

        <label>Você tem interesse em participar de uma próxima etapa da pesquisa em formato de entrevista?</label>
        <div class="radio-group">
            <label><input type="radio" name="interesseEntrevista" value="Sim" required> Sim</label>
            <label><input type="radio" name="interesseEntrevista" value="Não"> Não</label>
        </div>

        <div id="contatoDetalhe">
            <label for="emailContato">Informe um contato (E-mail ou Telefone) para agendamento:</label>
            <input type="text" id="emailContato" name="emailContato" placeholder="Ex: email@contato.com.br ou (21) 99999-9999">
        </div>
        <div id="message" class="loading">Tentando obter a localização automática. Por favor, aguarde e marque sua residência no mapa.</div>

        <button type="submit">Enviar Dados da Pesquisa</button>
    </form>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const latitudeResidencialInput = document.getElementById('latitudeResidencial');
        const longitudeResidencialInput = document.getElementById('longitudeResidencial');
        const latitudeAcessoInput = document.getElementById('latitudeAcesso');
        const longitudeAcessoInput = document.getElementById('longitudeAcesso');
        const messageDiv = document.getElementById('message');
        const outrasEscolasDetalheDiv = document.getElementById('outrasEscolasDetalhe');
        const detalheOutrasEscolasInput = document.getElementById('detalheOutrasEscolas');
        const contatoDetalheDiv = document.getElementById('contatoDetalhe'); 
        const emailContatoInput = document.getElementById('emailContato'); 
        
        // Radios da primeira pergunta
        const radioSimEscola = document.querySelector('input[name="trabalhaOutrasEscolas"][value="Sim"]');
        const radioNaoEscola = document.querySelector('input[name="trabalhaOutrasEscolas"][value="Não"]');
        
        // Radios da nova pergunta
        const radioSimContato = document.querySelector('input[name="interesseEntrevista"][value="Sim"]');
        const radioNaoContato = document.querySelector('input[name="interesseEntrevista"][value="Não"]');

        // --- 1. Lógica de Geolocalização do Navegador (Acesso) ---
        let autoLocationSuccess = false;

        if (navigator.geolocation) {
            
            messageDiv.className = 'loading';
            messageDiv.textContent = 'Tentando obter a localização automática (Acesso)... Por favor, permita o acesso e marque sua residência no mapa.';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    latitudeAcessoInput.value = lat.toFixed(6);
                    longitudeAcessoInput.value = lon.toFixed(6);
                    autoLocationSuccess = true;

                    // Atualiza a mensagem se o mapa ainda não foi marcado
                    if (latitudeResidencialInput.value === 'Marque seu local no mapa acima') {
                        messageDiv.className = 'success';
                        messageDiv.textContent = 'Localização de Acesso obtida. Agora, clique no mapa para marcar sua Residência e finalizar.';
                    }
                },
                (error) => {
                    let errorMessage = (error.code === error.PERMISSION_DENIED) ? "Permissão de localização negada (Acesso). Recarregue a página para tentar novamente." : "Erro ao obter localização automática (Acesso).";
                    latitudeAcessoInput.value = 'ERRO';
                    longitudeAcessoInput.value = 'ERRO';
                    autoLocationSuccess = false;
                    
                    // Atualiza a mensagem para alertar sobre o erro e pedir marcação manual
                    messageDiv.className = 'error';
                    messageDiv.textContent = `${errorMessage} Por favor, clique no mapa para marcar sua Residência e envie assim mesmo.`;
                },
                { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
            );

        } else {
            latitudeAcessoInput.value = 'N/A';
            longitudeAcessoInput.value = 'N/A';
            autoLocationSuccess = false;
            messageDiv.className = 'error';
            messageDiv.textContent = 'Seu navegador não suporta geolocalização automática. Por favor, marque sua residência no mapa.';
        }


        // --- 2. Lógica de Mapa (Leaflet - Residencial Manual) ---
        // Configurações iniciais do mapa: Centro na Região Metropolitana do RJ (-22.8, -43.1) e zoom 10
        const map = L.map('mapaResidencia').setView([-22.8, -43.1], 10);
        let marker = null; 
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // CORREÇÃO DE INICIALIZAÇÃO DO MAPA (Para evitar tiles cinzas)
        setTimeout(() => {
            map.invalidateSize();
        }, 100); 

        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([lat, lon]).addTo(map)
                .bindPopup("Sua Residência Marcada")
                .openPopup();

            // Preenche os campos MANUAIS (Residencial)
            latitudeResidencialInput.value = lat.toFixed(6);
            longitudeResidencialInput.value = lon.toFixed(6);

            // Atualiza a mensagem de status (se tudo estiver OK)
            messageDiv.className = 'success';
            messageDiv.textContent = `Localização Residencial marcada: Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}. Você já pode enviar o formulário.`;
        });

        // --- 3. Lógica do Formulário (Validações e Envio) ---
        
        // Lógica para mostrar/esconder o campo "Outras Escolas"
        radioSimEscola.addEventListener('change', () => {
            outrasEscolasDetalheDiv.style.display = radioSimEscola.checked ? 'block' : 'none';
            detalheOutrasEscolasInput.required = radioSimEscola.checked;
        });

        radioNaoEscola.addEventListener('change', () => {
            outrasEscolasDetalheDiv.style.display = 'none';
            detalheOutrasEscolasInput.required = false;
            detalheOutrasEscolasInput.value = ''; 
        });

        // Lógica para mostrar/esconder o campo "Contato"
        radioSimContato.addEventListener('change', () => {
            contatoDetalheDiv.style.display = radioSimContato.checked ? 'block' : 'none';
            emailContatoInput.required = radioSimContato.checked;
        });

        radioNaoContato.addEventListener('change', () => {
            contatoDetalheDiv.style.display = 'none';
            emailContatoInput.required = false;
            emailContatoInput.value = 'N/A'; // Define como N/A se Não for marcado
        });
        
        // LÓGICA DE ENVIO PARA O WEBHOOK
        document.getElementById('coletaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // !!! SUBSTITUA ESTA URL PELA SUA URL FINAL DO APPS SCRIPT AQUI !!!
            const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxI_IDE5FH2IPnNmDh5_FuA0EDn86YgnB0s3Rqp4tprkm9w-fOzU6tIaKJ33belk5OU8A/exec'; 

            const formData = new FormData(this);
            const dataToSend = {};
            formData.forEach((value, key) => {
                // Trata o campo de detalhe se a resposta for 'Não' para Outras Escolas
                if (key === 'detalheOutrasEscolas' && formData.get('trabalhaOutrasEscolas') === 'Não') {
                    dataToSend[key] = 'N/A';
                // Trata o campo de detalhe se a resposta for 'Não' para Contato
                } else if (key === 'emailContato' && formData.get('interesseEntrevista') === 'Não') {
                    dataToSend[key] = 'N/A';
                } else {
                    dataToSend[key] = value;
                }
            });

            // Validação OBRIGATÓRIA: Localização Residencial (Mapa)
            const isResidentialLocationMarked = (latitudeResidencialInput.value !== 'Marque seu local no mapa acima');
            
            if (!isResidentialLocationMarked || dataToSend.nomeEscola === "" || dataToSend.tempoTrabalho === "") {
                messageDiv.className = 'error';
                messageDiv.textContent = 'Erro! Preencha todos os campos obrigatórios e **marque sua residência no mapa** para obter as coordenadas residenciais.';
                return;
            }

            // Inicia o envio
            messageDiv.className = 'loading';
            messageDiv.textContent = 'Enviando dados...';

            fetch(WEBHOOK_URL, {
                method: 'POST',
                body: new URLSearchParams(dataToSend), 
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    console.error('Erro na resposta do Webhook:', response.status, response.statusText);
                    throw new Error('Falha na comunicação com o servidor.');
                }
            })
            .then(result => {
                document.getElementById('message').className = 'success';
                document.getElementById('message').textContent = 'Obrigado! Dados enviados com sucesso para a pesquisa da UFF.';
                document.getElementById('coletaForm').reset();
                outrasEscolasDetalheDiv.style.display = 'none';
                contatoDetalheDiv.style.display = 'none'; 
                
                // Reseta os marcadores e campos de localização
                if (marker) map.removeLayer(marker);
                latitudeResidencialInput.value = 'Marque seu local no mapa acima';
                longitudeResidencialInput.value = 'Marque seu local no mapa acima';
                latitudeAcessoInput.value = 'Tentando obter localização de acesso...';
                longitudeAcessoInput.value = 'Tentando obter localização de acesso...';
            })
            .catch(error => {
                console.error('Erro de Envio:', error);
                document.getElementById('message').className = 'error';
                document.getElementById('message').textContent = 'Erro de rede ou falha no Webhook. Tente novamente e verifique a URL do Google Apps Script.';
            });
        });
    });
</script>

</body>
</html>
